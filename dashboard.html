<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Ride and Roam</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* =================================
       RIDE & ROAM - PROFESSIONAL DASHBOARD
       Enterprise-Grade Travel Platform
       ================================= */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body.dashboard-page.premium-bg {
      background: 
        radial-gradient(circle at 15% 15%, rgba(0, 184, 212, 0.12), transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(0, 212, 255, 0.08), transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(45, 208, 111, 0.05), transparent 60%),
        linear-gradient(135deg, #0a0f1a 0%, #0f1729 25%, #162447 50%, #1f3461 75%, #243b5e 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #f8fafd;
      position: relative;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    
    .dashboard-bg-overlay {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: 
        repeating-radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.015) 0 3px, transparent 3px 60px),
        repeating-radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.015) 0 3px, transparent 3px 60px);
      pointer-events: none;
      opacity: 0.6;
      animation: subtleFloat 20s ease-in-out infinite;
    }
    
    @keyframes subtleFloat {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(10px, 10px); }
    }
    
    /* =================================
       SIDEBAR - PREMIUM NAVIGATION
       ================================= */
    .sidebar.premium-sidebar {
      position: fixed;
      left: 24px;
      top: 24px;
      bottom: 24px;
      width: 280px;
      background: linear-gradient(145deg, rgba(30, 36, 50, 0.95), rgba(22, 28, 42, 0.95));
      backdrop-filter: blur(30px) saturate(130%);
      border-radius: 24px;
      padding: 24px 16px;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.08) inset,
        0 0 80px rgba(0, 184, 212, 0.08);
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .sidebar.premium-sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #00d4ff, #00b8d4, transparent);
      opacity: 0.8;
    }
    
    .premium-logo {
      padding: 16px 12px 24px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 20px;
    }
    
    .premium-logo .logo {
      font-family: 'Poppins', 'Inter', sans-serif;
      font-size: 1.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff, #00b8d4, #2dd06f);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
      position: relative;
      animation: logoGlow 3s ease-in-out infinite;
    }
    
    @keyframes logoGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }
    
    .sidebar-profile {
      background: linear-gradient(145deg, rgba(40, 48, 65, 0.8), rgba(30, 36, 50, 0.8));
      border-radius: 16px;
      padding: 20px 16px;
      margin: 0 4px 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .sidebar-profile:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 184, 212, 0.15);
      border-color: rgba(0, 184, 212, 0.3);
    }
    
    .premium-nav {
      flex: 1;
      overflow-y: auto;
      padding: 8px 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 184, 212, 0.3) transparent;
    }
    
    .premium-nav::-webkit-scrollbar {
      width: 4px;
    }
    
    .premium-nav::-webkit-scrollbar-thumb {
      background: rgba(0, 184, 212, 0.3);
      border-radius: 10px;
    }
    
    .premium-nav .nav-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: transparent;
      border: 1px solid transparent;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .premium-nav .nav-btn::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #00d4ff, #00b8d4);
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    
    .premium-nav .nav-btn:hover {
      background: rgba(0, 184, 212, 0.08);
      color: #00d4ff;
      transform: translateX(4px);
      border-color: rgba(0, 184, 212, 0.2);
    }
    
    .premium-nav .nav-btn:hover::before {
      opacity: 1;
    }
    
    .premium-nav .nav-btn.active {
      background: linear-gradient(135deg, rgba(0, 184, 212, 0.15), rgba(0, 212, 255, 0.1));
      color: #00d4ff;
      border-color: rgba(0, 184, 212, 0.3);
      box-shadow: 
        0 4px 16px rgba(0, 184, 212, 0.2),
        0 0 0 1px rgba(0, 212, 255, 0.1) inset;
      font-weight: 700;
    }
    
    .premium-nav .nav-btn.active::before {
      opacity: 1;
    }
    
    .premium-nav .nav-btn .icon {
      font-size: 1.35rem;
      transition: transform 0.25s ease;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    
    .premium-nav .nav-btn:hover .icon,
    .premium-nav .nav-btn.active .icon {
      transform: scale(1.1);
    }
    
    .premium-logout-btn {
      margin-top: auto;
      background: linear-gradient(135deg, rgba(100, 100, 100, 0.2), rgba(80, 80, 80, 0.2));
      border-color: rgba(255, 255, 255, 0.1);
      margin-bottom: 0;
    }
    
    
    /* =================================
       MAIN DASHBOARD AREA
       ================================= */
    .dashboard.premium-dashboard {
      margin-left: 328px;
      padding: 24px 32px 48px;
      min-height: 100vh;
      position: relative;
      z-index: 10;
      max-width: 1600px;
    }
    
    .dashboard-top-header {
      background: linear-gradient(145deg, rgba(35, 43, 60, 0.9), rgba(28, 34, 48, 0.9));
      backdrop-filter: blur(30px) saturate(130%);
      border-radius: 20px;
      padding: 32px 36px;
      margin-bottom: 32px;
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }
    
    .dashboard-top-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00d4ff, #00b8d4, transparent);
      opacity: 0.6;
    }
    
    .dashboard-top-header:hover {
      box-shadow: 
        0 16px 50px rgba(0, 184, 212, 0.15),
        0 0 0 1px rgba(0, 212, 255, 0.15) inset;
      border-color: rgba(0, 184, 212, 0.2);
    }
    
    .greeting-main {
      font-size: 2.75rem;
      font-weight: 800;
      color: #fff;
      margin: 0 0 12px 0;
      letter-spacing: -0.03em;
      line-height: 1.2;
      background: linear-gradient(135deg, #fff, #e0f7ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .greeting-sub {
      font-size: 1.15rem;
      color: rgba(255, 255, 255, 0.65);
      margin: 0;
      font-weight: 400;
      line-height: 1.5;
    }
    
    /* =================================
       PROFESSIONAL CARD SYSTEM
       ================================= */
    .premium-card, .glass-card, .card {
      background: linear-gradient(145deg, rgba(35, 43, 60, 0.85), rgba(28, 34, 48, 0.85));
      backdrop-filter: blur(30px) saturate(130%);
      border-radius: 20px;
      padding: 28px 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .premium-card::before, .glass-card::before, .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00d4ff, #00b8d4, transparent);
      opacity: 0;
      transition: opacity 0.35s ease;
    }
    
    .premium-card::after, .glass-card::after, .card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 0%, rgba(0, 212, 255, 0.1), transparent 60%);
      opacity: 0;
      transition: opacity 0.35s ease;
    }
    
    .premium-card:hover, .glass-card:hover, .card:hover {
      transform: translateY(-8px) scale(1.01);
      box-shadow: 
        0 20px 60px rgba(0, 184, 212, 0.2),
        0 0 0 1px rgba(0, 212, 255, 0.2) inset;
      border-color: rgba(0, 184, 212, 0.3);
    }
    
    .premium-card:hover::before, .glass-card:hover::before, .card:hover::before,
    .premium-card:hover::after, .glass-card:hover::after, .card:hover::after {
      opacity: 1;
    }
    
    .card h3 {
      font-size: 1.45rem;
      font-weight: 700;
      color: #fff;
      margin: 0 0 18px 0;
      letter-spacing: -0.02em;
      line-height: 1.3;
      position: relative;
      padding-left: 16px;
    }
    
    .card h3::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      background: linear-gradient(180deg, #00d4ff, #00b8d4);
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }
    
    .card-body {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1rem;
      line-height: 1.7;
      position: relative;
      z-index: 1;
    }
    
    .card-body strong {
      color: #00d4ff;
      font-weight: 600;
    }
    
    /* Card Variations */
    .card-emergency {
      background: linear-gradient(145deg, rgba(255, 71, 87, 0.15), rgba(255, 61, 61, 0.12));
      border-color: rgba(255, 71, 87, 0.3);
    }
    
    .card-emergency::before {
      background: linear-gradient(90deg, transparent, #ff4757, #ff3d3d, transparent);
    }
    
    .card-emergency:hover {
      box-shadow: 
        0 20px 60px rgba(255, 71, 87, 0.25),
        0 0 0 1px rgba(255, 71, 87, 0.3) inset;
    }
    
    .card-emergency h3 {
      color: #ff4757;
    }
    
    
    /* =================================
       DASHBOARD CARDS GRID
       ================================= */
    .dashboard-main-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 28px;
      margin-bottom: 32px;
    }
    
    /* Journey Card */
    .journey-card {
      background: linear-gradient(145deg, rgba(0, 184, 212, 0.15), rgba(0, 150, 180, 0.12));
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 32px 28px;
      border: 1px solid rgba(0, 184, 212, 0.25);
      box-shadow: 
        0 12px 40px rgba(0, 184, 212, 0.15),
        0 0 0 1px rgba(0, 212, 255, 0.1) inset;
      position: relative;
      overflow: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .journey-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00d4ff, #00b8d4);
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
    }
    
    .journey-card:hover {
      transform: translateY(-8px);
      box-shadow: 
        0 24px 60px rgba(0, 184, 212, 0.25),
        0 0 0 1px rgba(0, 212, 255, 0.3) inset;
      border-color: rgba(0, 184, 212, 0.4);
    }
    
    .journey-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: rgba(45, 208, 111, 0.15);
      border: 1px solid rgba(45, 208, 111, 0.3);
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #2dd06f;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(45, 208, 111, 0.15);
    }
    
    .journey-status::before {
      content: '‚óè';
      font-size: 1.2rem;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.15);
      }
    }
    
    /* =================================
       PROFESSIONAL BUTTONS
       ================================= */
    .premium-btn, .btn-primary, button[class*="btn"] {
      background: linear-gradient(135deg, #00d4ff, #00b8d4);
      color: #fff;
      padding: 14px 32px;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 25px rgba(0, 184, 212, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.02em;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-transform: none;
    }
    
    .premium-btn::before, .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .premium-btn:hover, .btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 16px 40px rgba(0, 184, 212, 0.45),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
      background: linear-gradient(135deg, #00e1ff, #00c4e0);
    }
    
    .premium-btn:hover::before, .btn-primary:hover::before {
      opacity: 1;
    }
    
    .premium-btn:active, .btn-primary:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    /* Secondary Button */
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 184, 212, 0.4);
      box-shadow: 0 8px 25px rgba(0, 184, 212, 0.2);
    }
    
    /* Danger Button */
    .btn-danger, .emergency-btn {
      background: linear-gradient(135deg, #ff4757, #ff3d3d);
      box-shadow: 
        0 8px 25px rgba(255, 71, 87, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    }
    
    .btn-danger:hover, .emergency-btn:hover {
      background: linear-gradient(135deg, #ff5768, #ff4d4d);
      box-shadow: 
        0 16px 40px rgba(255, 71, 87, 0.45),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
    }
    
    /* =================================
       ACTION ITEMS & LINKS
       ================================= */
    .action-item, .dashboard-link {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      color: rgba(255, 255, 255, 0.85);
      text-decoration: none;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .action-item::before, .dashboard-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: linear-gradient(90deg, rgba(0, 212, 255, 0.15), transparent);
      transition: width 0.35s ease;
    }
    
    .action-item:hover, .dashboard-link:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(0, 184, 212, 0.3);
      color: #00d4ff;
      transform: translateX(6px);
      box-shadow: 0 8px 20px rgba(0, 184, 212, 0.15);
    }
    
    .action-item:hover::before, .dashboard-link:hover::before {
      width: 100%;
    }
    
    .action-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 184, 212, 0.15));
      border-radius: 12px;
      flex-shrink: 0;
      border: 1px solid rgba(0, 212, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    
    /* =================================
       PROFESSIONAL MODALS
       ================================= */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(10, 15, 25, 0.85);
      backdrop-filter: blur(15px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 24px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .modal-content {
      background: linear-gradient(145deg, rgba(30, 38, 53, 0.95), rgba(20, 26, 38, 0.95));
      backdrop-filter: blur(40px) saturate(150%);
      border-radius: 24px;
      padding: 40px 36px;
      box-shadow: 
        0 24px 80px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      border: 1px solid rgba(255, 255, 255, 0.15);
      max-width: 580px;
      width: 100%;
      position: relative;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00d4ff, #00b8d4, #00d4ff);
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
    }
    
    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      margin: 0;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #fff, #00d4ff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .close-modal {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .close-modal:hover {
      background: rgba(255, 71, 87, 0.15);
      border-color: rgba(255, 71, 87, 0.3);
      color: #ff4757;
      transform: rotate(90deg) scale(1.1);
    }
    
    .modal-body {
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.7;
    }
    
    /* Form Inputs in Modals */
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      font-size: 0.95rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 10px;
      letter-spacing: 0.01em;
    }
    
    .form-control, input[type="text"], input[type="email"], 
    input[type="password"], input[type="number"], select, textarea {
      width: 100%;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      color: #fff;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
      outline: none;
      backdrop-filter: blur(10px);
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .form-control:focus {
      background: rgba(255, 255, 255, 0.09);
      border-color: rgba(0, 212, 255, 0.5);
      box-shadow: 
        0 0 0 4px rgba(0, 184, 212, 0.12),
        0 8px 20px rgba(0, 184, 212, 0.15);
    }
    
    .form-control:hover {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 18px center;
      padding-right: 45px;
    }
    
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    /* =================================
       RESPONSIVE DESIGN
       ================================= */
    @media (max-width: 900px) {
      .dashboard.premium-dashboard {
        margin-left: 0;
        padding: 20px 16px;
      }
      
      .dashboard-sidebar.premium-sidebar {
        transform: translateX(-100%);
        z-index: 9999;
      }
      
      .dashboard-sidebar.premium-sidebar.active {
        transform: translateX(0);
      }
      
      .dashboard-main-cards {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .greeting-main {
        font-size: 2rem;
      }
      
      .dashboard-top-header {
        padding: 24px 20px;
      }
      
      .modal-content {
        padding: 28px 24px;
        margin: 16px;
      }
      
      .modal-title {
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 600px) {
      .greeting-main {
        font-size: 1.75rem;
      }
      
      .greeting-sub {
        font-size: 1rem;
      }
      
      .card h3 {
        font-size: 1.25rem;
      }
      
      .premium-btn, .btn-primary {
        padding: 12px 24px;
        font-size: 0.95rem;
      }
      
      .action-item, .dashboard-link {
        padding: 14px 16px;
        font-size: 0.95rem;
      }
      
      .dashboard-main-cards {
        gap: 16px;
      }
    }
    
    /* =================================
       LOADING STATES & ANIMATIONS
       ================================= */
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(0, 212, 255, 0.2);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 40px auto;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Fade In Animation for cards */
    .fade-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Stagger animation delays */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
    .card:nth-child(6) { animation-delay: 0.6s; }
    
    /* =================================
       UTILITY CLASSES
       ================================= */
    .text-gradient {
      background: linear-gradient(135deg, #00d4ff, #00b8d4);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .text-danger {
      color: #ff4757 !important;
    }
    
    .text-success {
      color: #2dd06f !important;
    }
    
    .text-muted {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    .mb-0 { margin-bottom: 0 !important; }
    .mb-1 { margin-bottom: 8px !important; }
    .mb-2 { margin-bottom: 16px !important; }
    .mb-3 { margin-bottom: 24px !important; }
    .mb-4 { margin-bottom: 32px !important; }
    
    .mt-0 { margin-top: 0 !important; }
    .mt-1 { margin-top: 8px !important; }
    .mt-2 { margin-top: 16px !important; }
    .mt-3 { margin-top: 24px !important; }
    .mt-4 { margin-top: 32px !important; }
    
    .d-flex { display: flex !important; }
    .align-items-center { align-items: center !important; }
    .justify-content-between { justify-content: space-between !important; }
    .gap-2 { gap: 16px !important; }
    .gap-3 { gap: 24px !important; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #00d4ff, #00b8d4);
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #00e1ff, #00c4e0);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }
    
    .premium-card::before, .glass-card::before, .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00b8d4, transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .premium-card:hover, .glass-card:hover, .card:hover {
      box-shadow: 0 16px 56px rgba(0, 184, 212, 0.25), 0 0 1px rgba(0, 184, 212, 0.5) inset;
      transform: translateY(-6px) scale(1.02);
      border-color: rgba(0, 184, 212, 0.4);
    }
    
    .premium-card:hover::before, .glass-card:hover::before, .card:hover::before {
      opacity: 1;
    }
    
    /* Enhanced Card Types */
    .card-emergency {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(255, 61, 61, 0.15));
      border-color: rgba(255, 71, 87, 0.3);
    }
    
    .card-emergency h3 {
      color: #ff4757 !important;
      text-shadow: 0 2px 10px rgba(255, 71, 87, 0.5);
    }
    
    .card-emergency .card-body {
      color: rgba(255, 255, 255, 0.95) !important;
    }
    
    .card-journey, .card-live {
      position: relative;
    }
    
    .card h3 {
      font-size: 1.35rem;
      font-weight: 700;
      color: #fff;
      margin: 0 0 1rem 0;
      letter-spacing: -0.01em;
    }
    
    .card-body {
      color: rgba(255, 255, 255, 0.85);
      font-size: 1rem;
      line-height: 1.6;
    }
    
    /* Map Placeholder Enhancement */
    .map-placeholder {
      background: linear-gradient(135deg, rgba(15, 23, 41, 0.7), rgba(24, 28, 43, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 180px;
      transition: all 0.3s ease;
    }
    
    .map-placeholder:hover {
      background: linear-gradient(135deg, rgba(15, 23, 41, 0.8), rgba(24, 28, 43, 0.6));
      border-color: rgba(0, 184, 212, 0.3);
    }
    
    /* Status Chip Enhancement */
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5em 1.2em;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 600;
      background: linear-gradient(135deg, #00b8d4, #00d4ff);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 184, 212, 0.4), 0 0 20px rgba(0, 184, 212, 0.2);
      letter-spacing: 0.3px;
      margin-top: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Button Enhancements */
    .btn.action {
      background: linear-gradient(135deg, #00b8d4, #00d4ff);
      color: #fff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 184, 212, 0.4), 0 0 20px rgba(0, 184, 212, 0.2);
      transition: all 0.3s ease;
    }
    
    .btn.action:hover {
      background: linear-gradient(135deg, #00d4ff, #00b8d4);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 184, 212, 0.5), 0 0 25px rgba(0, 184, 212, 0.3);
    }
    
    .btn.sos {
      background: linear-gradient(135deg, #ff4757, #ff3d3d);
      box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4), 0 0 30px rgba(255, 71, 87, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      font-weight: 800;
    }
    
    .btn.sos:hover {
      background: linear-gradient(135deg, #ff3d3d, #ff4757);
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(255, 71, 87, 0.5), 0 0 35px rgba(255, 71, 87, 0.3);
    }
    
    /* Dashboard Grid Enhancement */
    .dashboard-main-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
    
    /* Responsive Optimizations */
    @media (max-width: 900px) {
      .dashboard-main-cards {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 600px) {
      .premium-card, .glass-card, .card {
        border-radius: 16px;
      }
      
      .card h3 {
        font-size: 1.15rem;
      }
      
      .dashboard-main-cards {
        gap: 1rem;
      }
    }
    
    /* Animation for card entrance */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: slideInUp 0.5s ease-out;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    
    /* =================================
       ADDITIONAL CARD STYLES
       ================================= */
    .dest {
      font-size: 1.05rem;
      margin-bottom: 16px;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .dest strong {
      color: #00d4ff;
      font-weight: 600;
    }
    
    .card .btn {
      margin-top: 1.5em;
      width: 100%;
    }
    
    .dashboard-header h2 {
      font-size: 2.25rem;
      font-weight: 700;
      color: #fff;
      margin: 0;
      letter-spacing: -0.02em;
    }
    
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 28px;
    }
    
    /* Map Placeholder Enhancement */
    .map-placeholder {
      background: linear-gradient(135deg, rgba(15, 23, 41, 0.7), rgba(24, 28, 43, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 180px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .map-placeholder:hover {
      background: linear-gradient(135deg, rgba(15, 23, 41, 0.8), rgba(24, 28, 43, 0.6));
      border-color: rgba(0, 184, 212, 0.3);
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+4H8AW3+v1zT9sKq3tE2oMZbPp3y7F0zv+0M6p3r0=" crossorigin=""/>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page premium-bg">
  <div class="dashboard-bg-overlay"></div>
  <aside class="sidebar premium-sidebar">
    <div class="brand premium-logo">
      <div class="logo">Ride &amp; Roam</div>
    </div>
    <div class="sidebar-profile" id="sidebar-profile" style="padding:24px 20px;text-align:center;background:linear-gradient(135deg,rgba(35,43,58,0.9),rgba(29,36,51,0.9));border-radius:16px;margin:12px 8px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 4px 16px rgba(0,0,0,0.2);">
      <div style="font-size:1.25em;font-weight:700;color:#fff;margin-bottom:8px;" id="sidebar-profile-name">&nbsp;</div>
      <div style="font-size:1em;color:#00d4ff;font-weight:500;" id="sidebar-profile-username">&nbsp;</div>
    </div>
    <nav class="nav premium-nav">
      <button class="nav-btn" id="sidebar-bookings-btn" type="button" onclick="window.location.href='bookings.html'">
        <span class="icon">üè®</span>
        <span class="label">Bookings</span>
      </button>
      <button class="nav-btn" id="sidebar-trips-btn" type="button" onclick="window.location.href='trips.html'">
        <span class="icon">üß≥</span>
        <span class="label">Trips</span>
      </button>
      <button class="nav-btn" id="sidebar-mytrips-btn" type="button" onclick="window.location.href='my-trips.html'">
        <span class="icon">üóÇÔ∏è</span>
        <span class="label">Joined Trips</span>
      </button>
      <button class="nav-btn" id="sidebar-wallet-btn" type="button" onclick="window.location.href='wallet.html'">
        <span class="icon">üí∞</span>
        <span class="label">My Wallet</span>
      </button>
      <button class="nav-btn" id="sidebar-subscription-btn" type="button" onclick="window.location.href='subscription.html'" style="background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(123,47,247,0.15));border:1px solid rgba(0,212,255,0.3);">
        <span class="icon">‚≠ê</span>
        <span class="label">Premium</span>
      </button>
      <button class="nav-btn" data-key="settings" id="settings-btn">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Settings</span>
      </button>
    </nav>
    <div class="sidebar-foot premium-sidebar-foot">
      <button id="signout" class="nav-btn logout premium-logout-btn">
        <span class="icon">‚èª</span>
        <span class="label">Logout</span>
      </button>
    </div>
  </aside>

  <main class="dashboard premium-dashboard">
    <section id="section-mytrips" class="main-section" style="display:none">
      <h2>My Trips</h2>
      <div id="mytrips-content" class="cards"></div>
    </section>
      <script type="module">
        import { auth, db } from './firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        async function updateSidebarProfile(forceReload=false) {
          let profile = JSON.parse(localStorage.getItem('profile') || '{}');
          // Always force reload from Firestore after coming from edit-profile.html
          if (forceReload || sessionStorage.getItem('forceProfileReload')) {
            onAuthStateChanged(auth, async (user) => {
              if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                  const data = userDoc.data();
                  profile = {
                    name: data.name || '',
                    username: data.username || '',
                    phone: data.phone || '',
                    email: data.email || ''
                  };
                  localStorage.setItem('profile', JSON.stringify(profile));
                }
              }
              renderProfile(profile);
              sessionStorage.removeItem('forceProfileReload');
            });
          } else {
            renderProfile(profile);
          }
        }
        function renderProfile(profile) {
          document.getElementById('sidebar-profile-name').textContent = profile.name ? profile.name : '';
          document.getElementById('sidebar-profile-username').textContent = profile.username ? '@' + profile.username : '';
        }
        // Listen for profile updates from edit-profile.html
        window.addEventListener('profileUpdated', function() { updateSidebarProfile(true); });
        document.addEventListener('DOMContentLoaded', function() { updateSidebarProfile(true); });
        // Also listen for storage changes (other tabs/windows)
        window.addEventListener('storage', function(e) {
          if (e.key === 'profile') updateSidebarProfile();
        });
        // If redirected from edit-profile.html, force reload
        if (document.referrer && document.referrer.includes('edit-profile.html')) {
          sessionStorage.setItem('forceProfileReload', '1');
        }
      </script>
    <header class="dashboard-top-header">
      <div class="dashboard-greeting">
        <h1 id="welcome" class="greeting-main">Welcome</h1>
        <p id="sub" class="greeting-sub">Ready for your next ride?</p>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <!-- Premium Badge -->
        <a href="subscription.html" id="premium-badge" style="display:none;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,rgba(123,47,247,0.2),rgba(241,7,163,0.15));border:1px solid rgba(123,47,247,0.4);border-radius:14px;color:#fff;text-decoration:none;font-weight:700;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(123,47,247,0.2);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 25px rgba(123,47,247,0.35)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(123,47,247,0.2)'">
          <span style="font-size:1.3rem;">‚≠ê</span>
          <div style="display:flex;flex-direction:column;align-items:flex-start;">
            <span style="font-size:0.7rem;opacity:0.85;text-transform:uppercase;letter-spacing:0.8px;">Premium</span>
            <span id="premium-plan-name" style="font-size:1rem;font-weight:800;">Rider</span>
          </div>
        </a>
      </div>
    </header>
    <script>
      // Check and display premium badge
      function updatePremiumBadge() {
        const subscription = JSON.parse(localStorage.getItem('rnr_subscription') || '{}');
        const badge = document.getElementById('premium-badge');
        const planName = document.getElementById('premium-plan-name');
        
        if (subscription.active) {
          const now = new Date().getTime();
          const expiry = new Date(subscription.expiryDate).getTime();
          
          if (now <= expiry) {
            badge.style.display = 'inline-flex';
            if (planName) planName.textContent = subscription.plan || 'Rider';
          } else {
            badge.style.display = 'none';
          }
        } else {
          badge.style.display = 'none';
        }
      }
      
      updatePremiumBadge();
      setInterval(updatePremiumBadge, 5000);
      
      // Display wallet balance in header
      function updateWalletDisplay() {
        const walletData = JSON.parse(localStorage.getItem('rnr_wallet') || '{"balance":0}');
        const display = document.getElementById('wallet-balance-display');
        if (display) {
          display.textContent = walletData.balance + ' pts';
        }
      }
      updateWalletDisplay();
      // Update on storage changes
      window.addEventListener('storage', (e) => {
        if (e.key === 'rnr_wallet') updateWalletDisplay();
        if (e.key === 'rnr_subscription') updatePremiumBadge();
      });
      // Check periodically in case same-tab updates
      setInterval(updateWalletDisplay, 2000);
    </script>
        <!-- GROUPS SECTION -->
        <section id="section-groups" class="main-section" style="display:none">
          <div class="dashboard-header">
            <h2>Groups</h2>
            <button id="create-group-btn" class="btn action" style="margin-left:auto;">Create Group</button>
          </div>
          <div id="groups-list" class="cards"></div>
          <!-- Create Group Modal -->
          <div id="group-modal" class="modal" style="display:none;">
            <div class="modal-content card" style="max-width:420px;margin:32px auto;">
              <button class="modal-close" onclick="document.getElementById('group-modal').style.display='none'">‚úï</button>
              <h3>Create a Group</h3>
              <form id="group-form" autocomplete="off">
                <input type="text" id="group-name" placeholder="Group Name" required />
                <input type="text" id="group-destination" placeholder="Destination" required />
                <input type="date" id="group-start" required />
                <input type="date" id="group-end" required />
                <textarea id="group-desc" placeholder="Description" rows="2"></textarea>
                <select id="group-type">
                  <option value="public">Public</option>
                  <option value="private">Private</option>
                </select>
                <button type="submit" class="btn action" style="margin-top:12px;">Create</button>
              </form>
            </div>
          </div>
          <!-- Group Details Modal -->
          <div id="group-details-modal" class="modal" style="display:none;">
            <div class="modal-content card" style="max-width:480px;margin:32px auto;">
              <button class="modal-close" onclick="document.getElementById('group-details-modal').style.display='none'">‚úï</button>
              <!DOCTYPE html>
            </div>
          </div>
        </section>
    <section id="section-dashboard" class="main-section" style="display:block">
      <header class="dashboard-header">
        <div>
         
        </div>
      </header>
      <section class="cards premium-cards-grid dashboard-main-cards">
        <article class="card card-journey glass-card premium-card fade-in">
          <h3>Current Journey</h3>
          <div class="card-body">
            <div class="dest">Destination: <strong id="dest" class="text-gradient">‚Äî</strong></div>
            <div class="status status-chip journey-status"><span id="journey-status">No active journey</span></div>
            <button class="btn action premium-btn" id="current-journey-btn">
              <span>üß≥</span>
              <span>Your Trips</span>
            </button>
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            var journeyBtn = document.getElementById('current-journey-btn');
            if (journeyBtn) {
              journeyBtn.addEventListener('click', function() {
                window.location.href = 'current-journey.html';
              });
            }
          });
          </script>
          </div>
        </article>
        <article class="card card-live glass-card premium-card fade-in" id="liveLocationCard">
          <h3>Live Location</h3>
          <div class="card-body">
            <div id="live-map" class="map-placeholder">
              <span class="status-chip">Map: <span id="map-status">Ready</span></span>
            </div>
            <button class="btn action premium-btn open-live-btn" onclick="window.location.href='live-location.html';event.stopPropagation();">
              <span>üìç</span>
              <span>Open Live Location</span>
            </button>
          </div>
        </article>
      </section>
    </section>

    <section id="section-trips" class="main-section" style="display:none">
      <h2>Trips</h2>
      <div id="trips-content" class="cards"></div>
    </section>
    
      <section id="section-create-ride" class="main-section" style="display:none">
        <!-- Create Ride section removed as per requirements -->
      </section>

      <section id="section-join-ride" class="main-section" style="display:none">
        <!-- Join Ride section removed as per requirements -->
        <div id="join-ride-list" class="cards" style="max-width:900px;margin:0 auto 32px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px;"></div>
      </section>

    <section id="section-sos" class="main-section" style="display:none">
      <div class="dashboard-header mb-4">
        <h2 class="text-danger" style="font-size:2rem;text-shadow:0 2px 10px rgba(255,71,87,0.5);">üö® Emergency Assistance</h2>
      </div>
      <div class="cards" style="grid-template-columns:1fr;max-width:640px;margin:0 auto;gap:1.5rem;">
        <article class="card card-emergency premium-card fade-in">
          <h3>Current Trip</h3>
          <div class="card-body">
            <div id="sos-trip-info">No active trip</div>
          </div>
        </article>
        <article class="card card-live premium-card fade-in">
          <h3>Live Location</h3>
          <div class="card-body">
            <div id="sos-live-location">Locating...</div>
          </div>
        </article>
        <article class="card card-contacts premium-card fade-in">
          <h3>Emergency Contacts</h3>
          <div class="card-body d-flex" style="flex-direction:column;gap:12px;">
            <button class="btn premium-btn" onclick="alert('Calling emergency contact...')">
              <span>üìû</span>
              <span>Call Emergency</span>
            </button>
            <button class="btn premium-btn" onclick="alert('Messaging emergency contact...')">
              <span>üí¨</span>
              <span>Message</span>
            </button>
            <button class="btn premium-btn" onclick="alert('Location shared!')">
              <span>üìç</span>
              <span>Share Location</span>
            </button>
          </div>
        </article>
        <article class="card card-emergency" style="text-align:center;background:linear-gradient(135deg,rgba(255,71,87,0.25),rgba(255,61,61,0.2));border-color:rgba(255,71,87,0.4);">
          <h3 style="color:#ff4757;font-size:1.75rem;">SOS</h3>
          <div class="card-body">
            <button id="sos-main" class="btn sos" style="font-size:1.5rem;padding:24px 48px;width:100%;max-width:320px;">Send SOS</button>
            <div id="sos-confirmation" class="muted small" style="margin-top:16px;color:rgba(255,255,255,0.7);"></div>
          </div>
        </article>
      </div>
    </section>

    <section id="section-settings" class="main-section" style="display:none">
      <h2>Settings</h2>
      <div class="card" style="max-width:420px;margin:32px auto;">
        <div class="card-body">
          <p class="muted">Settings and preferences will appear here.</p>
        </div>
      </div>
    </section>

    <!-- Live Location & Map Section -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="live-location.css">

    <!-- Live Location card remains above; tracking panel removed for clean layout -->

    <!-- Removed tracking panel scripts -->
  <script>
  // Minimal redirect for Live Location card/button
  document.addEventListener('DOMContentLoaded', function() {
    var liveCard = document.querySelector('.card-live');
    if (liveCard) {
      liveCard.style.cursor = 'pointer';
      liveCard.addEventListener('click', function() {
        window.location.href = 'live-location.html';
      });
    }
  });
  </script>
  </main>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { doc, getDoc, setDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js';

    // --- Ride & Roam: Ride Sharing Logic ---
    const RIDES_KEY = 'rnr_rides';
    function getRides() {
      return JSON.parse(localStorage.getItem(RIDES_KEY) || '[]');
    }
    function saveRides(rides) {
      localStorage.setItem(RIDES_KEY, JSON.stringify(rides));
    }
    function getMyRides(userId) {
      return getRides().filter(r => r.owner === userId);
    }

    // Show only one main section at a time (sidebar logic)
    function showSection(key) {
      const sections = ['dashboard', 'trips', 'groups', 'bookings', 'sos', 'settings', 'create-ride', 'join-ride'];
      sections.forEach(sec => {
        const el = document.getElementById('section-' + sec);
        if (el) el.style.display = 'none';
      });
        // ...existing code...
      if (key === 'bookings') showKey = 'bookings';
      if (key === 'sos') showKey = 'sos';
      if (key === 'settings') showKey = 'settings';
      if (key === 'create-ride') showKey = 'create-ride';
      if (key === 'join-ride') showKey = 'join-ride';
      const showEl = document.getElementById('section-' + showKey);
      if (showEl) {
        showEl.style.display = 'block';
        showEl.style.opacity = 0.2;
        setTimeout(() => { showEl.style.opacity = 1; }, 120);
      }
      // Special: show groups list when switching to groups
      if (showKey === 'groups') showGroups();
      // Special: update SOS section when switching to SOS
      if (showKey === 'sos') updateSOSSection();
      // Special: update Trips section when switching to Trips
      if (showKey === 'trips') updateTripsSection();
      // Special: update Join Ride section
      if (showKey === 'join-ride') renderJoinRideList();
    }

    // Sidebar navigation logic for all menu items (override to support new items)
    function wireSidebarNav() {
      const navBtns = document.querySelectorAll('.nav-btn');
      navBtns.forEach(btn => {
        if (btn.id === 'sidebar-trips-btn') {
          btn.addEventListener('click', () => {
            window.location.href = 'trips.html';
          });
        } else if (btn.id === 'sidebar-bookings-btn') {
          btn.addEventListener('click', () => {
            window.location.href = 'bookings.html';
          });
        } else {
          btn.addEventListener('click', () => {
            navBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const key = btn.dataset.key;
            showSection(key);
          });
        }
      });
      // SOS main button in SOS section
      const sosMain = document.getElementById('sos-main');
      if(sosMain) sosMain.onclick = () => triggerSOS(true);
      // SOS card button in dashboard
      const sosCard = document.getElementById('sos');
      if(sosCard) sosCard.onclick = function() { window.location.href = 'nearby-help.html'; };
          // Nearby Help Modal UI
          function openNearbyHelpModal() {
            let modal = document.getElementById('nearby-help-modal');
            if (!modal) {
              modal = document.createElement('div');
              modal.id = 'nearby-help-modal';
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100vw';
              modal.style.height = '100vh';
              modal.style.background = 'rgba(18,14,12,0.92)';
              modal.style.zIndex = '9999';
              modal.style.display = 'flex';
              modal.style.flexDirection = 'column';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.innerHTML = `
                <div class="card" style="max-width:520px;width:96vw;padding:38px 28px;box-shadow:0 16px 48px rgba(18,14,10,0.55);border-radius:18px;">
                  <h2 style="margin-top:0;color:#ff3d3d;">Nearby Help</h2>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;margin:24px 0;">
                    <button class="btn action" style="width:100%">Hospitals</button>
                    <button class="btn action" style="width:100%">Police stations</button>
                    <button class="btn action" style="width:100%">Fuel stations</button>
                    <button class="btn action" style="width:100%">Electric stations</button>
                    <button class="btn action" style="width:100%">Mechanics / puncture shops</button>
                  </div>
                  <div class="muted" style="margin-bottom:18px;">You can implement later using Google Maps Places API.</div>
                  <button class="btn action" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
                  <button class="btn" style="margin-top:10px;background:rgba(255,255,255,0.08);color:#fff;" onclick="document.getElementById('nearby-help-modal').remove()">Close</button>
                </div>
              `;
              document.body.appendChild(modal);
            }
          }
      // Logout button
      const logoutBtn = document.getElementById('signout');
      if(logoutBtn) logoutBtn.onclick = async () => {
        // Firebase signOut if available, else clear session/local storage
        try {
          if (window.firebase && firebase.auth) {
            await firebase.auth().signOut();
          }
        } catch (e) {}
        localStorage.clear();
        if (window.sessionStorage) sessionStorage.clear();
        window.location.href = 'login.html';
      };
    }

    // --- Create Ride Form Logic ---
    function wireCreateRideForm(userId) {
      const form = document.getElementById('create-ride-form');
      if (!form) return;
      const priceType = document.getElementById('ride-price-type');
      const priceInput = document.getElementById('ride-price');
      priceType.addEventListener('change', () => {
        if (priceType.value === 'paid') priceInput.style.display = '';
        else { priceInput.style.display = 'none'; priceInput.value = ''; }
      });
      form.onsubmit = function(e) {
        e.preventDefault();
        const from = document.getElementById('ride-from').value.trim();
        const to = document.getElementById('ride-to').value.trim();
        const date = document.getElementById('ride-date').value;
        const time = document.getElementById('ride-time').value;
        const seats = parseInt(document.getElementById('ride-seats').value, 10);
        const priceTypeVal = priceType.value;
        const price = priceTypeVal === 'paid' ? parseFloat(priceInput.value) : 0;
        const notes = document.getElementById('ride-notes').value.trim();
        if (!from || !to || !date || !time || !seats || (priceTypeVal === 'paid' && isNaN(price))) return;
        const rides = getRides();
        const newRide = {
          id: 'r_' + Date.now(),
          from, to, date, time, seats, priceType: priceTypeVal, price, notes,
          owner: userId,
          driver: (getUser().name || 'You'),
          requests: [],
          createdAt: new Date().toISOString()
        };
        rides.push(newRide);
        saveRides(rides);
        form.reset();
        priceInput.style.display = 'none';
        document.getElementById('ride-create-confirm').textContent = 'Ride created! Added to My Rides.';
        setTimeout(() => { document.getElementById('ride-create-confirm').textContent = ''; }, 2000);
      };
    }

    // --- Join Ride Logic ---
    function renderJoinRideList(filter = {}) {
      const list = document.getElementById('join-ride-list');
      if (!list) return;
      let rides = getRides();
      // Filter by destination and date
      if (filter.dest) rides = rides.filter(r => r.to.toLowerCase().includes(filter.dest.toLowerCase()));
      if (filter.date) rides = rides.filter(r => r.date === filter.date);
      if (!rides.length) {
        list.innerHTML = '<div class="muted" style="grid-column:1/-1">No rides found. Try another search.</div>';
        return;
      }
      list.innerHTML = '';
      rides.forEach(r => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${r.from} ‚Üí ${r.to}</h3>
          <div><strong>Date:</strong> ${r.date} <strong>Time:</strong> ${r.time}</div>
          <div><strong>Driver:</strong> ${r.driver}</div>
          <div><strong>Seats:</strong> ${r.seats}</div>
          <div><strong>Type:</strong> ${r.priceType === 'free' ? 'Free' : '‚Çπ' + r.price}</div>
          <div style="margin-top:10px;display:flex;gap:10px;">
            <button class="btn action join-ride-btn">${r.priceType === 'free' ? 'Join Ride' : 'Request to Join'}</button>
          </div>
        `;
        card.querySelector('.join-ride-btn').onclick = () => {
          alert('Request sent to join this ride!');
        };
        list.appendChild(card);
      });
    }

    function wireJoinRideSearch() {
      const form = document.getElementById('join-ride-search-form');
      if (!form) return;
      form.onsubmit = function(e) {
        e.preventDefault();
        const dest = document.getElementById('join-dest').value.trim();
        const date = document.getElementById('join-date').value;
        renderJoinRideList({ dest, date });
      };
    }

    // --- Patch: wire up on load ---
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for auth/user, then wire forms
      setTimeout(() => {
        const user = getUser();
        wireCreateRideForm(user.id || 'demo');
        wireJoinRideSearch();
      }, 400);
    });

    const welcome = document.getElementById('welcome');
    const sub = document.getElementById('sub');

    // Sidebar navigation logic for all menu items
    function wireSidebarNav() {
      const navBtns = document.querySelectorAll('.nav-btn');
      const sections = ['dashboard', 'trips', 'groups', 'bookings', 'sos', 'settings'];
      navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          navBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const key = btn.dataset.key;
          showSection(key);
        });
      });
      // SOS main button in SOS section
      const sosMain = document.getElementById('sos-main');
      if(sosMain) sosMain.onclick = () => triggerSOS(true);
      // SOS card button in dashboard
      const sosCard = document.getElementById('sos');
      if(sosCard) sosCard.onclick = () => showSection('sos');
      // Logout button
      const logoutBtn = document.getElementById('signout');
      if(logoutBtn) logoutBtn.onclick = async () => {
        localStorage.clear();
        window.location.href = 'login.html';
      };
    }

    function showSection(key) {
      const sections = ['dashboard', 'trips', 'groups', 'bookings', 'sos', 'settings'];
      sections.forEach(sec => {
        const el = document.getElementById('section-' + sec);
        if (el) el.style.display = 'none';
      });
      let showKey = key;
      if (key === 'journey') showKey = 'dashboard';
      if (key === 'map' || key === 'trips') showKey = 'trips';
      if (key === 'groups') showKey = 'groups';
      if (key === 'bookings') showKey = 'bookings';
      if (key === 'sos') showKey = 'sos';
      if (key === 'settings') showKey = 'settings';
      const showEl = document.getElementById('section-' + showKey);
      if (showEl) {
        showEl.style.display = 'block';
        showEl.style.opacity = 0.2;
        setTimeout(() => { showEl.style.opacity = 1; }, 120);
      }
      // Special: show groups list when switching to groups
      if (showKey === 'groups') showGroups();
      // Special: update SOS section when switching to SOS
      if (showKey === 'sos') updateSOSSection();
      // Special: update Trips section when switching to Trips
      if (showKey === 'trips') updateTripsSection();
      // Update SOS section when shown
      if (showKey === 'sos' || showKey === 'SOS') updateSOSSection();
    }

    // Initialize Leaflet map
    function initMap(){
      map = L.map('map', { zoomControl: true }).setView([20,0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
      poiLayer = L.layerGroup().addTo(map);
      // simulate POIs around user when geolocation available
    }

    // Place sample POIs near given lat/lng
    function populatePOIs(lat, lng){
      poiLayer.clearLayers();
      const spread = 0.05;
      SAMPLE_POIS.forEach((p, idx)=>{
        p.lat = lat + (Math.random()-0.5)*spread;
        p.lng = lng + (Math.random()-0.5)*spread;
        const marker = L.marker([p.lat,p.lng], { title: p.title }).addTo(poiLayer);
        marker.bindPopup(`<strong>${p.title}</strong><div class=\"muted\">${p.type.toUpperCase()} ‚Ä¢ ${p.status}</div><div style=\"margin-top:8px;display:flex;gap:8px\"><button class=\"btn navigate\">Navigate</button><button class=\"btn book\">Book</button></div>`);
        marker.on('popupopen', ()=>{
          setTimeout(()=>{
            document.querySelectorAll('.navigate').forEach(b=>b.onclick = ()=>{ alert('Opening navigation to '+p.title); });
            document.querySelectorAll('.book').forEach(b=>b.onclick = ()=>{ openBookingWithPOI(p); });
          },50);
        });
      });
    }

    function openBookingWithPOI(poi){
      document.getElementById('view-bookings').style.display = 'block';
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.nav-btn[data-key="bookings"]').classList.add('active');
      renderBookings([poi]);
    }

    function renderBookings(list){
      const container = document.getElementById('booking-list');
      container.innerHTML = '';
      const items = list.length ? list : SAMPLE_POIS;
      items.forEach(it=>{
        const el = document.createElement('div'); el.className='booking-item card';
        el.innerHTML = `<h4>${it.title}</h4><div class=\"muted\">Type: ${it.type.toUpperCase()} ‚Ä¢ ${it.status}</div><div style=\"margin-top:8px\"><button class=\"btn action book-now\">Book / Reserve</button></div>`;
        el.querySelector('.book-now').onclick = ()=>{ confirmBooking(it); };
        container.appendChild(el);
      });
    }

    function confirmBooking(item){
      if(confirm(`Confirm booking for ${item.title}?`)){
        const bookings = JSON.parse(localStorage.getItem('rnr_bookings')||'[]');
        bookings.push({ id: item.id, title: item.title, type: item.type, at: new Date().toISOString() });
        localStorage.setItem('rnr_bookings', JSON.stringify(bookings));
        alert('Booking confirmed ‚Äî saved to Bookings.');
        renderBookings([]);
      }
    }

    // Simple search suggestions (local simulated data)
    const SAMPLE_PLACES = ['Pune, India','Mumbai, India','Bengaluru, India','Goa Beach','Manali','Leh, Ladakh','Kolkata','Jaipur'];
    function wireSearch(){
      const input = document.getElementById('dest-search');
      const sug = document.getElementById('suggestions');
      input.addEventListener('input', ()=>{
        const q = input.value.trim().toLowerCase();
        if(!q){ sug.hidden=true; return }
        const matches = SAMPLE_PLACES.filter(p=>p.toLowerCase().includes(q)).slice(0,6);
        sug.innerHTML = matches.map(m=>`<div class=\"sugg-item\">${m}</div>`).join('');
        sug.hidden = matches.length===0;
        sug.querySelectorAll('.sugg-item').forEach(el=>el.addEventListener('click', ()=>{ input.value = el.textContent; sug.hidden=true; showRouteTo(el.textContent); }));
      });
    }

    function showRouteTo(place){
      // simulate distance and ETA
      const dist = (Math.random()*600+20).toFixed(1);
      const eta = Math.floor(dist/60*60)+ ' mins';
      const journeyCard = document.querySelector('.card-journey .card-body');
      document.getElementById('dest').textContent = place;
      document.getElementById('journey-status').textContent = `Planned ‚Äî ${dist} km ‚Ä¢ ETA ${eta}`;
      // show nearby POIs along route (simulate by repopulating POIs around map center)
      if(map && userMarker){
        const latlng = userMarker.getLatLng();
        populatePOIs(latlng.lat, latlng.lng);
        showViewForKey('map');
      }
    }

    // SOS flow
    async function triggerSOS(){
      if(!confirm('Confirm SOS: notify emergency contacts and nearby travelers?')) return;
      const panel = document.querySelector('.card-emergency .card-body');
      panel.innerHTML = '<div class="muted">Locating you and notifying contacts...</div>';
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        // simulate sending alerts
        console.log('SOS sent with location', latitude, longitude);
        panel.innerHTML = `<div style=\"color:#fff;font-weight:800\">SOS sent</div><div class=\"muted\">Latitude: ${latitude.toFixed(5)}, Longitude: ${longitude.toFixed(5)}</div>`;
        // visually pulse the map
        if(map){ map.setView([latitude,longitude], 12); L.circle([latitude,longitude],{radius:200, color:'#ff3d3d',opacity:0.6}).addTo(map); }
      }, (err)=>{ panel.innerHTML = '<div class="muted">Unable to get location. SOS queued.</div>'; console.error(err); });
    }

    // Render initial bookings from storage
    function renderStoredBookings(){
      const bookings = JSON.parse(localStorage.getItem('rnr_bookings')||'[]');
      if(bookings.length===0) document.getElementById('booking-list').innerHTML = '<div class=\"muted\">No bookings yet. Search and book from the map or bookings panel.</div>';
      else {
        const container = document.getElementById('booking-list');
        container.innerHTML='';
        bookings.forEach(b=>{
          const el = document.createElement('div'); el.className='card booking-item';
          el.innerHTML = `<strong>${b.title}</strong><div class=\"muted\">${b.type.toUpperCase()} ‚Ä¢ ${new Date(b.at).toLocaleString()}</div>`;
          container.appendChild(el);
        });
      }
    }

    // Geolocate user and start map
    function tryGeolocate(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        if(!map) initMap();
        map.setView([latitude,longitude], 12);
        if(userMarker) userMarker.remove();
        userMarker = L.marker([latitude,longitude], { title:'You' }).addTo(map).bindPopup('You are here').openPopup();
        populatePOIs(latitude, longitude);
      }, (err)=>{ console.warn('geo failed', err); if(!map) initMap(); });
    }

    // GROUPS FEATURE LOGIC
    const GROUPS_KEY = 'rnr_groups';
    const USER_KEY = 'rnr_user';
    function getGroups() {
      return JSON.parse(localStorage.getItem(GROUPS_KEY) || '[]');
    }
    function saveGroups(groups) {
      localStorage.setItem(GROUPS_KEY, JSON.stringify(groups));
    }
    function getUser() {
      return JSON.parse(localStorage.getItem(USER_KEY) || '{}');
    }
    function showGroups() {
      const groups = getGroups();
      const list = document.getElementById('groups-list');
      list.innerHTML = '';
      if (!groups.length) {
        list.innerHTML = '<div class="muted">No groups found. Create one to get started!</div>';
        return;
      }
      groups.forEach(g => {
        const card = document.createElement('div');
        card.className = 'card group-card';
        card.innerHTML = `<h3>${g.name}</h3>
          <div><strong>Destination:</strong> ${g.destination}</div>
          <div><strong>Dates:</strong> ${g.start} to ${g.end}</div>
          <div><strong>Members:</strong> ${g.members.length}</div>
          <div><strong>Type:</strong> ${g.type}</div>
          <div style="margin-top:10px;display:flex;gap:10px;">
            <button class="btn action join-group-btn">${g.members.includes(getUser().id) ? 'Joined' : 'Join Group'}</button>
            <button class="btn" style="background:rgba(255,255,255,0.04);color:#fff;" onclick="showGroupDetails('${g.id}')">Details</button>
          </div>`;
        card.querySelector('.join-group-btn').onclick = () => joinGroup(g.id);
        list.appendChild(card);
      });
    }
    function joinGroup(groupId) {
      const groups = getGroups();
      const user = getUser();
      const idx = groups.findIndex(g => g.id === groupId);
      if (idx > -1 && !groups[idx].members.includes(user.id)) {
        groups[idx].members.push(user.id);
        saveGroups(groups);
        showGroups();
      }
    }
    function showGroupDetails(groupId) {
      const groups = getGroups();
      const g = groups.find(gr => gr.id === groupId);
      if (!g) return;
      const modal = document.getElementById('group-details-modal');
      const content = document.getElementById('group-details-content');
      content.innerHTML = `<h3>${g.name}</h3>
        <div><strong>Destination:</strong> ${g.destination}</div>
        <div><strong>Dates:</strong> ${g.start} to ${g.end}</div>
        <div><strong>Description:</strong> ${g.desc}</div>
        <div><strong>Type:</strong> ${g.type}</div>
        <div><strong>Members:</strong> ${g.members.length}</div>
        <div style="margin-top:10px;"><button class="btn action" onclick="showGroupChat('${g.id}')">Open Group Chat</button></div>`;
      modal.style.display = 'block';
    }
    function showGroupChat(groupId) {
      // Simple message board
      const chatKey = 'group_chat_' + groupId;
      const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
      const content = document.getElementById('group-details-content');
      content.innerHTML += `<div style="margin-top:18px;"><h4>Group Chat</h4><div id="chat-board" style="background:rgba(28,22,18,0.32);padding:10px;border-radius:10px;max-height:180px;overflow:auto;margin-bottom:8px;"></div><input id="chat-msg-input" placeholder="Type a message..." style="width:80%;padding:8px;border-radius:8px;border:1px solid #333;" /><button class="btn action" id="send-chat-btn">Send</button></div>`;
      const board = document.getElementById('chat-board');
      board.innerHTML = messages.map(m => `<div style='margin-bottom:6px;'><strong>${m.user}</strong>: ${m.text}</div>`).join('');
      document.getElementById('send-chat-btn').onclick = () => {
        const msg = document.getElementById('chat-msg-input').value.trim();
        if (!msg) return;
        messages.push({ user: getUser().name || 'You', text: msg });
        localStorage.setItem(chatKey, JSON.stringify(messages));
        board.innerHTML = messages.map(m => `<div style='margin-bottom:6px;'><strong>${m.user}</strong>: ${m.text}</div>`).join('');
        document.getElementById('chat-msg-input').value = '';
      };
    }
    document.getElementById('create-group-btn').onclick = () => {
      document.getElementById('group-modal').style.display = 'flex';
    };
    document.getElementById('group-form').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('group-name').value.trim();
      const destination = document.getElementById('group-destination').value.trim();
      const start = document.getElementById('group-start').value;
      const end = document.getElementById('group-end').value;
      const desc = document.getElementById('group-desc').value.trim();
      const type = document.getElementById('group-type').value;
      const user = getUser();
      if (!name || !destination || !start || !end) return;
      const groups = getGroups();
      const newGroup = {
        id: 'g_' + Date.now(),
        name,
        destination,
        start,
        end,
        desc,
        type,
        members: [user.id],
        owner: user.id,
        requests: []
      };
      groups.push(newGroup);
      saveGroups(groups);
      document.getElementById('group-modal').style.display = 'none';
      showGroups();
    };
    // Show groups when section is visible
    function handleSectionSwitch(key) {
      if (key === 'groups') showGroups();
    }
    // Hook into sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        handleSectionSwitch(btn.dataset.key);
      });
    });
    // ...existing code...

    // Wire everything after auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='login.html'; return }
      try{
        const snap = await getDoc(doc(db,'users',user.uid));
        let profileData = null;
        let isFirstLogin = false;
        if(!snap.exists()){
          const name = user.displayName || (user.email? user.email.split('@')[0] : 'Traveler');
          const profile = { name, email: user.email || null, phone: user.phoneNumber || null, subscription: false, createdAt: serverTimestamp() };
          await setDoc(doc(db,'users',user.uid), profile);
          profileData = profile;
          isFirstLogin = true;
        } else {
          profileData = snap.data();
        }
        welcome.textContent = `Hello, ${profileData.name || 'Traveler'}`;
        window.rnrUser = user;

        function restrictDashboard() {
          document.getElementById('subscription').style.display = 'block';
          sub.textContent = 'A subscription is required to access the dashboard. Please complete payment.';
        }

        if(!profileData.subscription){
          restrictDashboard();
          const payBtn = document.getElementById('pay-now');
          if(payBtn){ payBtn.addEventListener('click', showPaymentModal); }
          document.getElementById('signout').addEventListener('click', async ()=>{ await signOut(auth); location.href='login.html'; });
          setTimeout(()=>{ showPaymentModal(); }, 600);
          function onPaymentSuccess(ev) {
            if(!profileData.subscription) {
              finalizeSubscription(ev.detail);
            }
          }
          function onPaymentCancelled(ev) {
            restrictDashboard();
            setTimeout(()=>{ showPaymentModal(); }, 600);
          }
          window.addEventListener('easypayio:payment:success', onPaymentSuccess);
          window.addEventListener('easypayio:payment:cancelled', onPaymentCancelled);
          setTimeout(()=>{
            if(typeof EasyPayIO !== 'undefined'){
              EasyPayIO.pay({
                amount: 99.00,
                productName: 'RideAndRoam Subscription',
                productDescription: 'Annual subscription for Ride & Roam features',
                userEmail: window.rnrUser && window.rnrUser.email ? window.rnrUser.email : '',
                onSuccess: function(response){
                  finalizeSubscription(response);
                },
                onFailure: function(error){
                  restrictDashboard();
                  setTimeout(()=>{ showPaymentModal(); }, 600);
                }
              });
            }
          }, 1200);
          return;
        }

        // Subscribed: initialize full dashboard
        sub.textContent = 'The world is open. Ride gently.';
        wireSidebarNav();
        // ...existing code for search, groups, bookings, map, etc...
        wireSearch && wireSearch();
        wireGroups && wireGroups();
        renderStoredBookings && renderStoredBookings();
        initMap && initMap();
        tryGeolocate && tryGeolocate();
        const payBtn = document.getElementById('pay-now');
        if(payBtn){ payBtn.addEventListener('click', showPaymentModal); }
        document.getElementById('signout').addEventListener('click', async ()=>{ await signOut(auth); location.href='login.html'; });
      }catch(err){ console.error(err); sub.textContent = 'Failed to load profile'; }
    });

    /* Payment modal logic */
    function showPaymentModal(){
      const modal = document.getElementById('payment-modal');
      modal.style.display = 'flex';
      modal.querySelectorAll('.pm-method').forEach(m=>m.classList.remove('selected'));
      modal.querySelector('.pm-method[data-method="card"]').classList.add('selected');
      showMethodForm('card');
      document.getElementById('pm-status').textContent = '';
    }
    function closePaymentModal(){ document.getElementById('payment-modal').style.display = 'none'; }
    function showMethodForm(method){
      document.querySelectorAll('.pm-form').forEach(f=>f.style.display='none');
      const el = document.querySelector(`.pm-form[data-method="${method}"]`);
      if(el) el.style.display='block';
      document.getElementById('pm-selected').textContent = method.toUpperCase();
    }
    async function confirmPayment(){
      const status = document.getElementById('pm-status');
      const payBtn = document.querySelector('#payment-modal .btn.pay');
      payBtn.disabled = true;
      status.textContent = 'Processing payment...';
      // prefer EasyPayIO when available
      if(typeof EasyPayIO !== 'undefined'){
        try{
          EasyPayIO.pay({
            amount:99.00,
            productName:'RideAndRoam Subscription',
            productDescription: 'Annual subscription for Ride & Roam features',
            userEmail: window.rnrUser && window.rnrUser.email ? window.rnrUser.email : '',
            onSuccess: async (resp)=>{ status.textContent = 'Payment successful. Finalizing...'; try{ await postPaymentToWebhook(window.rnrUser && window.rnrUser.uid, resp); }catch(e){ console.warn('webhook notify failed', e); } await finalizeSubscription(resp); },
            onFailure: (err)=>{ console.error('EasyPayIO error', err); status.textContent = 'Payment failed or cancelled.'; payBtn.disabled=false; }
          });
        }catch(e){ console.error('EasyPayIO invocation failed', e); status.textContent = 'Payment SDK error.'; payBtn.disabled=false; }
        return;
      }
      // fallback simulated flow
      await new Promise(r=>setTimeout(r,1200));
      await finalizeSubscription();
    }
    async function finalizeSubscription(paymentResp){
      const status = document.getElementById('pm-status');
      try{
        if(!window.rnrUser){ status.textContent = 'User not available. Please login again.'; return; }
        status.textContent = 'Updating subscription...';
        await updateDoc(doc(db,'users',window.rnrUser.uid), { subscription: true, subscriptionAt: serverTimestamp() });
        status.textContent = 'Payment successful ‚Äî subscription activated.';
        document.getElementById('subscription').style.display = 'none';
        // Initialize and reveal interactive features for subscribed users
        document.getElementById('features').style.display = 'block';
        try{
          wireNav(); wireSearch(); wireGroups(); renderStoredBookings();
          if(!map) initMap(); tryGeolocate();
        }catch(e){ console.warn('initialize after subscribe failed', e); }
        setTimeout(()=>{ closePaymentModal(); },900);
        // Send webhook notification (best-effort)
        try{ if(paymentResp) await postPaymentToWebhook(window.rnrUser && window.rnrUser.uid, paymentResp); }catch(e){ console.warn('post-payment webhook failed', e); }
      }catch(err){ console.error(err); status.textContent = 'Payment succeeded but failed to update profile.'; }
    }

    // Post payment result to server webhook (configure URL below)
    const EASYPAY_WEBHOOK = 'https://your-domain.com/easypayWebhook';
    async function postPaymentToWebhook(userUid, paymentResp){
      try{
        const payload = { event: 'payment.succeeded', data: { userUid: userUid || null, amount: paymentResp && (paymentResp.amount || paymentResp.amount === 0) ? paymentResp.amount : 99, txId: paymentResp && (paymentResp.transactionId || paymentResp.txId) ? (paymentResp.transactionId || paymentResp.txId) : null, raw: paymentResp } };
        console.log('posting payment to webhook', EASYPAY_WEBHOOK, payload);
        await fetch(EASYPAY_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      }catch(e){ console.warn('postPaymentToWebhook failed', e); }
    }

    // Emergency SOS section logic
    function updateSOSSection() {
      // Show current trip info
      const tripInfo = document.getElementById('sos-trip-info');
      const dest = document.getElementById('dest') ? document.getElementById('dest').textContent : '‚Äî';
      const status = document.getElementById('journey-status') ? document.getElementById('journey-status').textContent : 'No active trip';
      tripInfo.innerHTML = `<strong>Destination:</strong> ${dest}<br><strong>Status:</strong> ${status}`;
      // Show live location
      const locDiv = document.getElementById('sos-live-location');
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          locDiv.textContent = `Latitude: ${pos.coords.latitude.toFixed(5)}, Longitude: ${pos.coords.longitude.toFixed(5)}`;
        }, () => {
          locDiv.textContent = 'Unable to get location.';
        });
      } else {
        locDiv.textContent = 'Geolocation not supported.';
      }
    }
    // SOS button confirmation
    const sosMainBtn = document.getElementById('sos-main');
    if (sosMainBtn) {
      sosMainBtn.onclick = function() {
        const confirmDiv = document.getElementById('sos-confirmation');
        confirmDiv.innerHTML = '<span style="color:#ff3d3d;font-weight:700">Confirm sending SOS?</span> <button class="btn sos" id="sos-confirm-btn">Yes, Send</button>';
        document.getElementById('sos-confirm-btn').onclick = function() {
          confirmDiv.textContent = 'SOS sent! Emergency contacts notified.';
          // Add actual SOS logic here
        };
      };
    }

    function updateTripsSection() {
      const tripsContent = document.getElementById('trips-content');
      if (!tripsContent) return;
      tripsContent.innerHTML = `<div class='card'>
        <h3>Journey Details</h3>
        <div><strong>Destination:</strong> ${document.getElementById('dest') ? document.getElementById('dest').textContent : '‚Äî'}</div>
        <div><strong>Status:</strong> ${document.getElementById('journey-status') ? document.getElementById('journey-status').textContent : 'No active trip'}</div>
      </div>
      <div class='card'>
        <h3>Bookings</h3>
        <div id='trips-bookings-list'>No bookings yet.</div>
      </div>`;
      // Optionally, copy booking list from Bookings section
      const bookingList = document.getElementById('booking-list');
      if (bookingList) {
        document.getElementById('trips-bookings-list').innerHTML = bookingList.innerHTML;
      }
    }
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="./easypayio-gateway.js"></script>
  <!-- Payment modal -->
  <div id="payment-modal" class="payment-modal" style="display:none">
    <div class="pm-card">
      <button class="pm-close" onclick="closePaymentModal()">‚úï</button>
      <h3>Subscribe ‚Äî ‚Çπ99</h3>
      <div class="pm-intro muted">Choose a payment method</div>
      <div class="pm-methods">
        <button class="pm-method" data-method="card" onclick="document.querySelectorAll('.pm-method').forEach(m=>m.classList.remove('selected')); this.classList.add('selected'); showMethodForm('card')">Card</button>
        <button class="pm-method" data-method="upi" onclick="document.querySelectorAll('.pm-method').forEach(m=>m.classList.remove('selected')); this.classList.add('selected'); showMethodForm('upi')">UPI</button>
        <button class="pm-method" data-method="wallet" onclick="document.querySelectorAll('.pm-method').forEach(m=>m.classList.remove('selected')); this.classList.add('selected'); showMethodForm('wallet')">Wallet</button>
      </div>
      <div class="pm-forms">
        <div class="pm-form" data-method="card">
          <input placeholder="Card number" />
          <div style="display:flex;gap:8px;margin-top:8px"><input placeholder="MM/YY" /><input placeholder="CVC" /></div>
        </div>
        <div class="pm-form" data-method="upi" style="display:none">
          <input placeholder="UPI ID (alice@upi)" />
        </div>
        <div class="pm-form" data-method="wallet" style="display:none">
          <div class="muted">Select wallet on your phone after confirming.</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <div style="flex:1" class="muted small">Method: <span id="pm-selected">CARD</span></div>
        <button class="btn pay" onclick="confirmPayment()">Pay ‚Çπ99</button>
      </div>
      <div id="pm-status" class="muted small" style="margin-top:10px"></div>
    </div>
  </div>
    <!-- Debug panel (for local testing) -->
    <div id="debug-panel" style="display:none">
      <div class="debug-tools">
        <button id="dbg-toggle-logs" class="btn action">Toggle Logs</button>
        <button id="dbg-force-pay" class="btn action">Force Payment Success</button>
        <button id="dbg-clear" class="btn">Clear</button>
      </div>
      <pre id="dbg-log" class="muted small"></pre>
    </div>

    <script>
      // Debug helpers to reproduce EasyPayIO flows locally
      (function(){
        const dbgPanel = document.getElementById('debug-panel');
        const dbgLog = document.getElementById('dbg-log');
        function log(...args){ console.log(...args); if(dbgLog){ dbgLog.textContent += new Date().toISOString() + ' - ' + args.map(a=> (typeof a==='object'? JSON.stringify(a): String(a))).join(' ') + '\n'; dbgLog.scrollTop = dbgLog.scrollHeight; } }

        // Toggle panel via keyboard shortcut: Ctrl+Shift+D
        window.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='d'){ dbgPanel.style.display = dbgPanel.style.display==='none' ? 'block' : 'none'; } });

        document.getElementById('dbg-toggle-logs').addEventListener('click', ()=>{ dbgLog.style.display = dbgLog.style.display==='none' ? 'block' : 'none'; });
        document.getElementById('dbg-clear').addEventListener('click', ()=>{ dbgLog.textContent=''; });
        document.getElementById('dbg-force-pay').addEventListener('click', ()=>{
          // simulate the payment popup posting back a success message
          const payload = { type: 'PAYMENT_SUCCESS', transactionId: 'txn_demo_' + Date.now(), amount:99.00, productName: 'RideAndRoam Subscription', timestamp: new Date().toISOString(), userId: (window.rnrUser && window.rnrUser.uid) || null };
          log('FORCE POSTMESSAGE', payload);
          // send message to window origin so SDK listener will pick it up
          window.postMessage(payload, window.origin);
          // also dispatch the CustomEvent that the SDK emits
          try{ window.dispatchEvent(new CustomEvent('easypayio:payment:success',{ detail: payload })); }catch(e){ log('dispatch event failed', e); }
        });

        // Listen for events dispatched by EasyPayIO SDK
        window.addEventListener('easypayio:payment:success', (ev)=>{ log('EasyPayIO success event', ev.detail); const s = document.getElementById('pm-status') || document.getElementById('signup-pay-status') || document.getElementById('pay-status'); if(s) s.textContent = 'Payment verified (event)'; });
        window.addEventListener('easypayio:payment:cancelled', (ev)=>{ log('EasyPayIO cancelled', ev.detail); const s = document.getElementById('pm-status') || document.getElementById('signup-pay-status') || document.getElementById('pay-status'); if(s) s.textContent = 'Payment cancelled'; });

        // Capture raw postMessage traffic for debugging
        window.addEventListener('message', (ev)=>{ try{ log('postMessage', { origin: ev.origin, data: ev.data }); }catch(e){} });

        // Expose a simple logger in console for manual triggers
        window.RNRDebug = { log, showPanel: ()=>{ dbgPanel.style.display='block'; }, hidePanel: ()=>{ dbgPanel.style.display='none'; } };
        log('Debug tools initialized. Toggle with Ctrl+Shift+D');
      })();
    </script>

      <script>
        // Ensure EasyPayIO SDK is available ‚Äî try dynamic load if missing
        (function(){
          function ensureSDK(){
            if(typeof EasyPayIO === 'undefined'){
              console.warn('EasyPayIO SDK not present ‚Äî attempting dynamic load');
              var s = document.createElement('script');
              s.src = './easypayio-gateway.js';
              s.onload = function(){ console.log('EasyPayIO SDK loaded dynamically'); var el = document.getElementById('pay-status'); if(el) el.textContent = 'Payment SDK loaded'; };
              s.onerror = function(){ console.error('Failed to load EasyPayIO SDK'); var el = document.getElementById('pay-status'); if(el) el.textContent = 'Payment SDK unavailable'; };
              document.body.appendChild(s);
            } else {
              console.log('EasyPayIO SDK already present');
            }
          }

          // Ensure dashboard background is set (fallback)
          function ensureBackground(){
            try{
              const cs = window.getComputedStyle(document.body);
              if(!cs || cs.backgroundImage === 'none' || cs.backgroundImage === 'initial'){
                const url = 'https://images.unsplash.com/photo-1505575967453-1dc4b66a1eaf?auto=format&fit=crop&w=2000&q=80';
                document.body.style.backgroundImage = `url(${url})`;
                console.log('Applied fallback dashboard background');
              }
            }catch(e){ console.warn('background check failed', e); }
          }

          // Run checks after a short delay to allow CSS/scripts to load
          window.addEventListener('load', function(){ setTimeout(function(){ ensureSDK(); ensureBackground(); }, 300); });
        })();

        // Settings and Logout handlers
        document.getElementById('settings-btn').addEventListener('click', function() {
          window.location.href = 'settings.html';
        });

        document.getElementById('signout').addEventListener('click', async function() {
          try {
            // Try Firebase sign out
            const { auth } = await import('./firebase-init.js');
            const { signOut } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');
            await signOut(auth);
          } catch (e) {
            console.warn('Firebase not available, clearing local storage');
          }
          // Clear localStorage
          localStorage.removeItem('rideRoamSettings');
          localStorage.removeItem('rideRoamBookings');
          localStorage.removeItem('rideRoamTrips');
          localStorage.removeItem('rideRoamPayments');
          localStorage.removeItem('rideRoamTransactions');
          localStorage.removeItem('rideandroam_phoneVerified'); // if any
          // Show toast
          showToast('Logged out successfully');
          setTimeout(() => window.location.href = 'login.html', 1000);
        });

        function showToast(message) {
          const toast = document.createElement('div');
          toast.textContent = message;
          toast.style.position = 'fixed';
          toast.style.bottom = '20px';
          toast.style.left = '50%';
          toast.style.transform = 'translateX(-50%)';
          toast.style.background = '#333';
          toast.style.color = '#fff';
          toast.style.padding = '10px';
          toast.style.borderRadius = '5px';
          toast.style.zIndex = '1000';
          document.body.appendChild(toast);
          setTimeout(() => document.body.removeChild(toast), 3000);
        }
      </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var liveBtn = document.getElementById('live-location-btn');
  if (liveBtn) {
    liveBtn.addEventListener('click', function() {
      window.location.href = 'live-location.html';
    });
  }
});
</script>
</body>
</html>
